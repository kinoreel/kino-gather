#!groovy

node {
    registry_url = "${REGISTRY_URL}"
    build_tag = "latest"

    stage 'Git'
    git([ url: 'https://github.com/kinoreel/kino-gather.git', branch: '${BRANCH}'])


    maintainer_name = "${MAINTAINER}"
    container_name = "gather-${API_NAME}"
    stage "Building Docker image"
    container = docker.build("${registry_url}/${maintainer_name}/${container_name}:${build_tag}", ' --build-arg KAFKA_BROKER=${KAFKA_BROKER} --build-arg API_KEY=${API_KEY} --build-arg API_NAME=${API_NAME} apis')

    stage "Pushing Docker image"
    sh 'gcloud docker -- push "http://${registry_url}/${maintainer_name}/${container_name}:${build_tag}"'

    currentBuild.result = 'SUCCESS'

    stage 'Deploy'
    sh 'kubectl create -f apis/kubernetes-deployments/${API_NAME}-deployment.yaml'
}