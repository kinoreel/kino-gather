#!groovy

node {
    registry_url = "${env.REGISTRY_URL}"
    build_tag = "latest"
    def apis = ["omdb", "tmdb", "itunes", "youtube"];
    stage 'Git'
    git([ url: 'https://github.com/kinoreel/kino-gather.git', branch: 'apis'])
    sh 'gcloud docker --authorize-only'
    for (i = 0; i <apis.size(); i++) {
        def API_KEY
        switch(apis[i]) {
            case 'omdb':
            API_KEY = "${env.OMDB_KEY}"
            break
            case 'tmdb':
            API_KEY = "${env.TMDB_KEY}"
            break
            case 'youtube':
            API_KEY = "${env.YOUTUBE_KEY}"
            break
            case 'itunes':
            API_KEY = ""
            break
        }

        maintainer_name = "${env.MAINTAINER}"
        container_name = "gather-${apis[i]}"
        image_name = "${registry_url}/${maintainer_name}/${container_name}:${build_tag}"
        stage "Building ${image_name} Docker image"
        container = docker.build("${image_name}", " --build-arg KAFKA_BROKER=${env.KAFKA_BROKER} --build-arg API_KEY=${API_KEY} --build-arg API_NAME=${apis[i]} apis")

        stage "Pushing ${image_name} Docker image"
        sh "docker push ${image_name}"
        sh "docker rmi ${image_name}"

        currentBuild.result = 'SUCCESS'

        stage "Deploy ${apis[i]}"
        sh "kubectl apply -f apis/kubernetes-deployments/${apis[i]}-deployment.yaml"
    }
}